@page "/"
@inject ITranslationService TranslationService
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">

    @* ── 標題列 ── *@
    <div class="d-flex align-center justify-space-between mb-3">
        <MudText Typo="Typo.h5">
            <MudIcon Icon="@Icons.Material.Filled.Translate" Class="mr-2" />
            TranslateGemma
        </MudText>
        <MudIconButton Icon="@(IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       title="@(IsDarkMode ? "切換亮色模式" : "切換深色模式")"
                       OnClick="() => ToggleTheme?.Invoke()" />
    </div>

    @* ── 對話歷史區 ── *@
    @if (_history.Count == 0)
    {
        <MudPaper Elevation="0" Class="pa-6 mb-4 text-center"
                  Style="background:var(--mud-palette-background-grey); border-radius:12px; border:1px dashed var(--mud-palette-divider);">
            <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.body1" Class="mt-2" Color="Color.Secondary">
                輸入文字後點擊「翻譯」，這裡會顯示翻譯結果
            </MudText>
        </MudPaper>
    }
    else
    {
        <div id="chat-area" class="mb-4" style="max-height:55vh; overflow-y:auto; padding:4px 2px;">
            @foreach (var item in _history)
            {
                @* 原文泡泡（右） *@
                <ChatBubble Text="@item.OriginalText"
                            IsUser="true"
                            Timestamp="@item.Timestamp" />
                @* 譯文泡泡（左） *@
                <ChatBubble Text="@(item.IsError ? (item.ErrorMessage ?? "翻譯失敗") : item.TranslatedText)"
                            IsUser="false"
                            IsError="@item.IsError"
                            IsPending="@item.IsPending"
                            Timestamp="@item.Timestamp"
                            LangLabel="@(item.IsError || item.IsPending ? null : item.TargetLang)" />
            }
        </div>
    }

    @* ── 輸入框 ── *@
    <TranslationInput IsSubmitting="@_isSubmitting"
                      OnSubmit="HandleSubmit"
                      OnCancel="HandleCancel" />

    @* ── Toast 通知 ── *@
    <ToastNotification Message="@_toastMessage"
                       Severity="@_toastSeverity"
                       Visible="@_toastVisible"
                       VisibleChanged="@((v) => _toastVisible = v)" />

</MudContainer>

@code {
    [CascadingParameter(Name = "IsDarkMode")] public bool IsDarkMode { get; set; }
    [CascadingParameter(Name = "ToggleTheme")] public Action? ToggleTheme { get; set; }

    private List<TranslationHistory> _history = new();
    private bool _isSubmitting;
    private System.Threading.CancellationTokenSource? _streamCts;

    private bool _toastVisible;
    private string _toastMessage = string.Empty;
    private Severity _toastSeverity = Severity.Info;

    private static string DetectTargetLang(string text) =>
        text.Any(c => c >= 0x4E00 && c <= 0x9FFF) ? "en" : "zh-TW";

    private async Task HandleSubmit(string text)
    {
        var targetLang = DetectTargetLang(text);
        var entry = new TranslationHistory
        {
            OriginalText = text,
            TargetLang = targetLang,
            IsPending = true,
        };
        _history.Add(entry);
        if (_history.Count > 50) _history.RemoveAt(0);

        _isSubmitting = true;
        StateHasChanged();
        await ScrollToBottom();

        _streamCts = new System.Threading.CancellationTokenSource();
        var req = new TranslationRequest { Text = text, SourceLang = null, TargetLang = targetLang, Stream = true };
        string accumulated = string.Empty;
        string finalSource = string.Empty;
        bool hasError = false;
        string? errorMsg = null;

        try
        {
            await foreach (var token in TranslationService.TranslateStreamAsync(req, _streamCts.Token))
            {
                if (token.Error != null) { hasError = true; errorMsg = token.Error; break; }
                if (!token.Done) { accumulated += token.Token; }
                else { finalSource = token.SourceLang ?? string.Empty; }
            }
        }
        catch (System.OperationCanceledException)
        {
            hasError = true;
            errorMsg = "翻譯已取消";
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMsg = $"連線錯誤：{ex.Message}";
        }

        entry.IsPending = false;
        entry.TranslatedText = hasError ? string.Empty : accumulated;
        entry.SourceLang = finalSource;
        entry.IsError = hasError;
        entry.ErrorMessage = errorMsg;
        _isSubmitting = false;

        if (hasError && errorMsg != null)
            ShowToast(errorMsg, Severity.Error);

        StateHasChanged();
        await ScrollToBottom();
    }

    private void HandleCancel() => _streamCts?.Cancel();

    private void ShowToast(string msg, Severity severity = Severity.Info)
    {
        _toastMessage = msg;
        _toastSeverity = severity;
        _toastVisible = true;
    }

    private async Task ScrollToBottom()
    {
        try { await JS.InvokeVoidAsync("scrollToBottom", "chat-area"); }
        catch { }
    }
}

