@namespace TranslateGemma.Components
@inject IJSRuntime JS

@* 對話泡泡：原文右側（藍），譯文左側（灰），錯誤紅色 *@
<div class="chat-bubble-wrapper @(IsUser ? "user-side" : "system-side")">
    <MudPaper Elevation="1"
              Style="@BubbleStyle"
              Class="chat-bubble pa-3">
        @if (IsError)
        {
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" Class="mr-1" />
        }
        <span class="bubble-text" style="white-space:pre-wrap; font-size:14px; line-height:1.5;">@Text</span>

        <div class="bubble-footer d-flex align-center justify-space-between mt-1">
            <MudText Typo="Typo.caption" Style="opacity:.6; font-size:12px;">
                @Timestamp.ToString("HH:mm:ss")
                @if (!string.IsNullOrEmpty(LangLabel))
                { <span class="ml-1">· @LangLabel</span> }
            </MudText>

            @if (!IsUser && !IsError && !string.IsNullOrEmpty(Text))
            {
                <div class="copy-btn-wrapper" style="position:relative;">
                    <MudIconButton Icon="@(Copied ? Icons.Material.Filled.Check : Icons.Material.Filled.ContentCopy)"
                                   Size="Size.Small"
                                   Color="@(Copied ? Color.Success : Color.Default)"
                                   title="複製譯文"
                                   OnClick="CopyText"
                                   Style="margin:-4px;" />
                    @if (Copied)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Success"
                                 Style="position:absolute;right:28px;top:4px;white-space:nowrap;font-size:11px;">
                            已複製
                        </MudText>
                    }
                </div>
            }
        </div>
    </MudPaper>
</div>

<style>
    .chat-bubble-wrapper { display:flex; margin-bottom:8px; }
    .user-side  { justify-content:flex-end; }
    .system-side{ justify-content:flex-start; }
    .chat-bubble{ max-width:70%; border-radius:12px !important; }
    @@media (max-width:767px) { .chat-bubble { max-width:90%; } }
</style>

@code {
    [Parameter] public string Text { get; set; } = string.Empty;
    [Parameter] public bool IsUser { get; set; }
    [Parameter] public bool IsError { get; set; }
    [Parameter] public DateTime Timestamp { get; set; } = DateTime.Now;
    [Parameter] public string? LangLabel { get; set; }

    private bool Copied { get; set; }
    private System.Threading.CancellationTokenSource? _copyCts;

    private string BubbleStyle => IsError
        ? "background:#FFEBEE; border-radius:12px;"
        : IsUser
            ? "background:#E3F2FD; border-radius:12px;"
            : "background:#F5F5F5; border-radius:12px;";

    private async Task CopyText()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", Text);
        }
        catch
        {
            try { await JS.InvokeVoidAsync("clipboardFallback", Text); }
            catch { /* 顯示複製失敗提示，但不中斷 */ }
        }

        _copyCts?.Cancel();
        _copyCts = new System.Threading.CancellationTokenSource();
        Copied = true;
        StateHasChanged();

        try
        {
            await Task.Delay(2000, _copyCts.Token);
            Copied = false;
            StateHasChanged();
        }
        catch (TaskCanceledException) { }
    }
}
