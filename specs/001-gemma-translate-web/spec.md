# Feature Specification: TranslateGemma 網頁翻譯服務

**Feature Branch**: `001-gemma-translate-web`  
**Created**: 2026-02-17  
**Status**: Draft  
**Input**: User description: "建立一個類似 ChatGPT 對話介面的網頁翻譯服務，後端串接本地 TranslateGemma 模型（4B / 12B），讓使用者透過瀏覽器即可進行多語言文字翻譯。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本文字翻譯 (Priority: P1)

使用者開啟網頁後，能夠在輸入框中輸入文字，點擊送出按鈕，系統顯示翻譯結果。這是最核心的功能，讓使用者能夠完成端到端的翻譯任務。

**Why this priority**: 這是服務的核心價值主張。沒有這個功能，整個服務將沒有實質意義。使用者必須能夠輸入文字並獲得翻譯結果。

**Independent Test**: 可以透過開啟網頁、輸入任意文字（如 "Hello World"）、點擊翻譯按鈕並驗證是否顯示翻譯結果來完整測試。這個測試不依賴任何其他功能。

**Acceptance Scenarios**:

1. **Given** 使用者開啟翻譯網頁，**When** 使用者在輸入框輸入文字並點擊送出，**Then** 系統應在 30 秒內顯示翻譯結果
2. **Given** 使用者已送出一次翻譯，**When** 使用者輸入新的文字並再次送出，**Then** 系統應在對話區域顯示新的翻譯結果
3. **Given** 使用者輸入超長文字（超過 1000 字元），**When** 送出翻譯請求，**Then** 系統應正常處理或顯示友善的錯誤訊息
4. **Given** 翻譯服務後端未啟動，**When** 使用者送出翻譯請求，**Then** 系統應在對話區域顯示清楚的錯誤訊息泡泡（如「無法連線至翻譯服務」）而非空白或崩潰

---

### User Story 2 - 語言選擇 (Priority: P2)

使用者能夠從下拉選單中選擇來源語言和目標語言，系統根據使用者選擇的語言對進行翻譯。

**Why this priority**: 雖然翻譯功能可以使用預設語言對運作，但使用者需要能夠自訂語言對才能滿足多樣化的翻譯需求。這是讓服務實際可用的關鍵功能。

**Independent Test**: 可以透過選擇不同語言對（如英文→中文、日文→英文）並驗證翻譯結果是否符合所選語言來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者開啟網頁，**When** 使用者點擊語言下拉選單，**Then** 系統應顯示至少 15 種常用語言選項（主要為繁體中文與英文）
2. **Given** 使用者輸入英文文字（未手動選擇語言），**When** 送出翻譯請求，**Then** 系統應自動偵測為英文並翻譯成繁體中文
3. **Given** 使用者輸入繁體中文文字（未手動選擇語言），**When** 送出翻譯請求，**Then** 系統應自動偵測為繁體中文並翻譯成英文
4. **Given** 使用者手動選擇特定語言對，**When** 使用者輸入文字並送出，**Then** 系統應使用手動選擇的語言對而非自動偵測
5. **Given** 使用者選擇相同的來源和目標語言，**When** 送出翻譯請求，**Then** 系統應顯示友善提示或自動複製原文

---

### User Story 3 - 對話式介面與歷史記錄 (Priority: P3)

使用者的翻譯請求和結果以對話泡泡的形式呈現，類似聊天介面。使用者可以在當次瀏覽期間查看歷史翻譯記錄。

**Why this priority**: 對話式介面提升使用體驗，讓使用者能夠輕鬆追蹤多次翻譯的上下文。但即使沒有這個功能，使用者仍能完成基本翻譯任務。

**Independent Test**: 可以透過連續進行 3 次翻譯，並驗證所有翻譯記錄是否都保留在頁面上來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者開啟網頁，**When** 使用者連續送出 3 次翻譯請求，**Then** 頁面應顯示全部 3 組原文與翻譯結果
2. **Given** 使用者已有多筆翻譯記錄，**When** 使用者向上捲動頁面，**Then** 使用者應能查看所有歷史翻譯記錄
3. **Given** 使用者已有翻譯記錄，**When** 使用者重新整理頁面或關閉瀏覽器，**Then** 所有翻譯記錄應被清除（不持久化）
4. **Given** 對話區域顯示多筆記錄，**When** 頁面佈局調整，**Then** 對話泡泡應保持「使用者輸入（原文）在右側、系統回應（譯文）在左側」的布局並保持可讀性

---

### User Story 4 - 串流輸出與複製功能 (Priority: P4)

翻譯結果以串流方式逐字逐句顯示，使用者能夠在翻譯完成後點擊複製按鈕將結果複製到剪貼簿。

**Why this priority**: 串流輸出和複製功能提升使用體驗和便利性，但不影響核心翻譯功能。使用者即使沒有這些功能也能完成翻譯任務。

**Independent Test**: 可以透過送出翻譯請求、觀察結果是否逐步顯示、點擊複製按鈕並檢查剪貼簿內容來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者送出翻譯請求，**When** 後端開始回傳結果，**Then** 翻譯文字應以逐 token 方式逐步出現而非一次性顯示完整內容
2. **Given** 翻譯結果已完整顯示，**When** 使用者點擊複製按鈕，**Then** 翻譯文字應被複製到系統剪貼簿
3. **Given** 使用者複製翻譯結果，**When** 複製成功，**Then** 系統應顯示視覺回饋（如「已複製」提示）
4. **Given** 串流輸出過程中，**When** 網路連線中斷，**Then** 系統應顯示錯誤訊息並保留已接收的部分翻譯

---

### Edge Cases

- **空白輸入**：使用者未輸入任何文字就點擊送出時，系統應透過 Toast 通知顯示提示訊息（如「請輸入文字」）而非發送請求
- **特殊字元**：使用者輸入包含 emoji、符號、換行符號的文字時，系統應正確處理並保留格式
- **超長文字**：使用者輸入超過 5000 字元時，系統應透過 Toast 通知顯示友善提示（「文字過長，請限制在 5000 字元以內」）並阻止送出，或自動截斷至 5000 字元並明確告知使用者
- **翻譯逾時**：模型推論超過 120 秒仍未完成時，系統應在對話區域顯示錯誤訊息泡泡（如「翻譯逾時，請稍後重試」）並中斷請求
- **模型未載入**：後端服務啟動但模型尚未載入完成時，翻譯請求應在對話區域回傳明確的錯誤訊息（如「模型初始化中，請稍候片刻」）
- **不支援的語言對**：使用者選擇的語言對模型不支援時，系統應透過 Toast 通知在送出前告知使用者，或在回傳時在對話區域顯示錯誤
- **多視窗並行**：同一使用者在多個瀏覽器分頁/視窗同時使用服務時，每個視窗的翻譯記錄應獨立管理

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供文字輸入介面讓使用者輸入待翻譯文字
- **FR-001a**: 系統必須限制輸入文字長度不超過 5000 字元，並在超過限制時提供明確的錯誤提示
- **FR-002**: 系統必須提供來源語言和目標語言的選擇介面，至少支援 15 種常用語言（包含英文、繁體中文、日文、韓文、法文、德文、西班牙文、葡萄牙文、俄文、義大利文、阿拉伯文、印地文、泰文、越南文、印尼文）。**主要語言對為繁體中文（zh-TW）<-> 英文（en）**，不支援簡體中文
- **FR-002a**: 系統必須提供自動語言偵測功能，當使用者未手動選擇語言時，自動偵測輸入文字的語言（初期僅支援繁體中文與英文偵測）
- **FR-002b**: 系統必須實作智能語言切換邏輯：偵測到繁體中文時自動設定目標語言為英文，偵測到英文時自動設定目標語言為繁體中文
- **FR-003**: 系統必須在使用者送出翻譯請求後，將原文送至後端 API 進行翻譯
- **FR-004**: 系統必須以對話式介面呈現翻譯結果，使用者輸入的原文顯示在右側，系統回應的譯文顯示在左側（符合現代聊天應用慣例）
- **FR-005**: 系統必須支援串流方式接收並顯示翻譯結果，串流顆粒度為逐 token（模型輸出的最小單位）
- **FR-006**: 系統必須在翻譯結果旁提供複製按鈕，讓使用者能一鍵複製翻譯文字
- **FR-007**: 系統必須在當次瀏覽期間保留所有翻譯記錄於記憶體中，不做持久化儲存
- **FR-008**: 系統必須在使用者重新整理頁面或關閉瀏覽器時清除所有翻譯記錄
- **FR-009**: 系統必須支援桌面與行動裝置的響應式佈局
- **FR-010**: 後端必須提供翻譯 API 端點，接收原文、來源語言碼、目標語言碼並回傳翻譯結果
- **FR-011**: 後端必須支援 Server-Sent Events (SSE) 串流回應方式
- **FR-012**: 後端必須提供語言清單 API 端點，回傳系統支援的所有語言及其語言碼
- **FR-013**: 後端必須提供健康檢查 API 端點，回傳服務狀態、載入的模型名稱及推論裝置資訊
- **FR-014**: 後端必須透過設定檔載入模型配置，包含模型選擇（4B 或 12B）、裝置選擇（CPU / CUDA / MPS）、資料型別等參數
- **FR-015**: 後端必須支援在 Apple MPS、NVIDIA CUDA、CPU 三種裝置上進行模型推論
- **FR-016**: 系統必須在翻譯請求超過設定的 timeout（預設 120 秒）時中斷處理並回傳逾時錯誤
- **FR-017**: 系統必須提供雙層錯誤訊息顯示機制：輕量錯誤（如空白輸入、格式驗證失敗）透過 Toast 通知顯示 3-5 秒後自動消失；嚴重錯誤（如翻譯失敗、後端無回應、逾時）在對話區域顯示錯誤訊息泡泡並保留在歷史記錄中

### Key Entities

- **翻譯請求 (TranslationRequest)**: 代表單次翻譯任務，包含原文文字、來源語言碼、目標語言碼、是否使用串流輸出
- **翻譯回應 (TranslationResponse)**: 代表翻譯結果，包含翻譯後文字、來源語言碼、目標語言碼
- **語言 (Language)**: 代表系統支援的語言，包含語言碼（如 "en"、"zh-TW"）和語言名稱（如 "English"、"Traditional Chinese"）。主要支援繁體中文與英文，不支援簡體中文
- **翻譯記錄 (TranslationHistory)**: 代表使用者的歷史翻譯，包含原文、譯文、語言對、時間戳記，僅存在於瀏覽器記憶體中

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在 30 秒內完成單次文字翻譯（使用 4B 模型），60 秒內完成翻譯（使用 12B 模型）
- **SC-002**: 系統支援最新版本的 Chrome、Firefox、Safari、Edge 瀏覽器訪問並正常運作
- **SC-003**: 使用者能在桌面電腦、平板、手機等不同裝置上正常使用翻譯服務
- **SC-004**: 95% 的正常翻譯請求（文字長度 < 500 字元）能在 20 秒內回傳第一個 token
- **SC-005**: 系統能透過 Docker/Podman Compose 在 5 分鐘內完成一鍵部署並啟動服務
- **SC-006**: 使用者能在不修改程式碼的情況下，透過修改設定檔切換不同模型（4B / 12B）和推論裝置（CPU / CUDA / MPS）
- **SC-007**: 串流輸出的翻譯結果能在 1 秒內開始逐步顯示（而非等待完整翻譯完成）
- **SC-008**: 使用者能在翻譯完成後 1 次點擊內完成結果複製動作
- **SC-009**: 系統能在後端模型未載入或發生錯誤時，向使用者顯示清楚的錯誤訊息而非空白或崩潰

## Clarifications

### Session 2026-02-17

- Q: 輸入文字長度限制：規格中提到「超長文字（超過 1000 字元）」和「超過模型處理上限」，但沒有明確定義實際的字元數上限。實際的硬性字元數上限應該是多少？ → A: 5000 字元（長文檔，可能較慢）
- Q: 預設語言對：當使用者首次開啟網頁時，來源語言和目標語言的預設值應該是什麼？ → A: 輸入中文則翻譯英文，輸入英文則翻譯中文（先不考慮其他語言）- 系統應自動偵測輸入語言並智能切換目標語言
- Q: 串流輸出顆粒度：規格提到「翻譯結果以串流方式逐字逐句顯示」，但沒有明確串流的顆粒度（逐 token / 逐詞 / 逐句）。實際的串流顆粒度應該是什麼？ → A: 逐 token（模型輸出單位，最即時）
- Q: 對話泡泡布局方向：規格提到「對話泡泡應左右對齊（原文左，譯文右）」，但這與常見的對話介面習慣可能有衝突。實際的視覺布局邏輯應該是什麼？ → A: 使用者輸入（原文）右、系統回應（譯文）左 - 符合現代聊天應用慣例
- Q: 錯誤訊息的顯示方式與持續時間：規格提到多種錯誤情境（後端未啟動、模型未載入、翻譯逾時、空白輸入等），但沒有說明錯誤訊息應該如何顯示以及何時消失。錯誤訊息的顯示策略應該是什麼？ → A: Toast 通知（3-5 秒自動消失）+ 對話區域錯誤訊息 - 輕量錯誤用 Toast，嚴重錯誤在對話區域顯示保留歷史